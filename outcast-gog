#!/bin/bash
# Date : (2011-11-27 19-47)
# Last revision : (2011-11-28 01-44)
# Wine version used : 1.3.27-rawinput2
# Distribution used to test : Debian Sid (Unstable)
# Author : Pierre Etchemaite <petchema@concept-micro.com>
# Script licence : GPL v.2
# Program licence : Retail
# Depend : none

[ -z "$PLAYONLINUX" ] && exit 0
source "$PLAYONLINUX/lib/sources"

abort () {
    POL_SetupWindow_message_image "The installation has been aborted." "Error" "$PLAYONLINUX/themes/tango/warning.png"
    POL_SetupWindow_Close
    exit 1
}

check_install_archive () {
#    POL_SetupWindow_wait_next_signal "Checking install archive..." "Outcast"

    EXPECTED_SIZE=1409323648
    EXPECTED_MD5="a8bf2336a580527f0eb99f8b90009c33"

    SIZE="$(stat -c%s $APP_ANSWER)"
    MD5="$(md5sum $APP_ANSWER|cut -c1-32)"

#    POL_SetupWindow_detect_exit

    if [ $SIZE != $EXPECTED_SIZE -o "$MD5" -ne "$EXPECTED_MD5" ]; then
	POL_SetupWindow_message_image "Either your install archive is corrupted, or is not the expected version.\nThis script cannot guarantee that installation will work correctly. Please report success or failure to PlayOnLinux forums.\n\nSize: $SIZE (expected $EXPECTED_SIZE)\nMD5: $MD5 (expected $EXPECTED_MD5)" "Install archive mismatch" "$PLAYONLINUX/themes/tango/warning.png"
	POL_SetupWindow_question "Continue?" "Install archive mismatch"
	[ "$APP_ANSWER" -ne "TRUE" ] && abort
    fi
}


PREFIX="Outcast-gog"
SHORTCUT_NAME="Outcast"
WORKING_WINE_VERSION="1.3.27-rawinput2"

POL_SetupWindow_Init
POL_SetupWindow_presentation "Outcast (GoG release)" "Appeal S.A. / Atari" "http://www.gog.com/en/gamecard/outcast" "Pierre Etchemaite" "$PREFIX"
 
 
select_prefix "$DIRECTORY/wineprefix/$PREFIX/"
POL_SetupWindow_prefixcreate
cd $HOME
POL_SetupWindow_browse "Plese select the location of the install file" "Select file"

# Doesn't work
# check_install_archive

POL_SetupWindow_install_wine "$WORKING_WINE_VERSION"
Use_WineVersion "$WORKING_WINE_VERSION"


POL_SetupWindow_wait_next_signal "Installing Outcast..." "Outcast"

# Associate .PDF with native app 
# http://wiki.winehq.org/FAQ#head-91bf3f0a8ccbfab8dee96f82fae2f1a489e0d243
# Do it before installing the game, so you have the possibility to open
# PDFs with Win32 reader if you choose to install it
cat <<'EOF' > $DIRECTORY/tmp/pdfnativereader.reg
[HKEY_CLASSES_ROOT\.pdf]
@="PDFfile"
"Content Type"="application/pdf"
[HKEY_CLASSES_ROOT\PDFfile\Shell\Open\command]
@="winebrowser \"%1\""
EOF
wine regedit $DIRECTORY/tmp/pdfnativereader.reg


wine "$APP_ANSWER" || abort

# Main game will crash if desktop size is not constrained
Set_Desktop "On" "640" "480"

# Only works perfectly with rawinput; Otherwise makes loader menu funky
# (grab the menu around to put wanted entry at the center of screen,
# release then click!), but the rest of the game is more enjoyable
#Set_DXGrab "On"


# Set_GrabFullScreen anyone?
cat <<'EOF' > $DIRECTORY/tmp/grabfullscreen.reg
REGEDIT4

[HKEY_CURRENT_USER\Software\Wine\X11 Driver]
"GrabFullscreen"="Y"
EOF
wine regedit $DIRECTORY/tmp/grabfullscreen.reg

POL_SetupWindow_detect_exit

# Doesn't hurt ;)
POL_SetupWindow_reboot 


# Warning, /windows/command/ also contains a start.exe, so
# POL_SetupWindow_auto_shortcut can fail
POL_SetupWindow_make_shortcut "$PREFIX" "Program Files/GOG.com/Outcast/" "start.exe" "${SHORTCUT_NAME}.ICO" "$SHORTCUT_NAME"
Set_WineVersion_Assign "$WORKING_WINE_VERSION" "$SHORTCUT_NAME"

POL_SetupWindow_make_shortcut "$PREFIX" "/" "start" "" "Outcast user manual" "" "'Program Files/GOG.com/Outcast/manual.pdf'"


POL_SetupWindow_Close

cat <<EOF > $DIRECTORY/configurations/configurators/Outcast
#!/bin/bash
[ -z "\$PLAYONLINUX" ] && exit 0
source "\$PLAYONLINUX/lib/sources"
export WINEPREFIX="$DIRECTORY/wineprefix/$PREFIX"
export WINEDEBUG=""
cd "\$WINEPREFIX/drive_c/Program Files/GOG.com/Outcast/" || exit 1

CURRENT_LANG=English
[ -f pol_configuration ] && source pol_configuration

POL_SetupWindow_Init

# Other language directories are incomplete (?)
POL_SetupWindow_menu_list "Choose language" "Voices and subtitles" "English~French~German" "~" "\$CURRENT_LANG"
CURRENT_LANG="\$APP_ANSWER"
case "\$CURRENT_LANG" in
    English)
        ln -sf Data/Voices/ENGLISH/FIX.PAK fix.pak
        ln -sf Data/Voices/ENGLISH/TEXT.PAK text.pak
        ln -sf Data/Voices/ENGLISH/VOICES1.PAK voices1+.pak
        ln -sf Data/Voices/ENGLISH/VOICES2.PAK voices2+.pak
        ln -sf Data/Voices/ENGLISH/VOICES3.PAK voices3+.pak
        ln -sf Data/Voices/ENGLISH/VOICES4.PAK voices4+.pak
        ln -sf Data/Voices/ENGLISH/VOICES5.PAK voices5+.pak
        ln -sf Data/Voices/ENGLISH/VOICES6.PAK voices6+.pak
        ln -sf Data/Voices/ENGLISH/VOICESGE.PAK voicesgen+.pak
        ;;
    French)
        ln -sf Data/Voices/French/FIX.PAK fix.pak
        ln -sf Data/Voices/French/TEXT.PAK text.pak
        ln -sf Data/Voices/French/VOICES1.PAK voices1+.pak
        ln -sf Data/Voices/French/VOICES2.PAK voices2+.pak
        ln -sf Data/Voices/French/VOICES3.PAK voices3+.pak
        ln -sf Data/Voices/French/VOICES4.PAK voices4+.pak
        ln -sf Data/Voices/French/VOICES5.PAK voices5+.pak
        ln -sf Data/Voices/French/VOICES6.PAK voices6+.pak
        ln -sf Data/Voices/French/VOICESGE.PAK voicesgen+.pak
        ;;
    German)
        ln -sf Data/Voices/German/FIX.PAK fix.pak
        ln -sf Data/Voices/German/TEXT.PAK text.pak
        ln -sf Data/Voices/German/VOICES1.PAK voices1+.pak
        ln -sf Data/Voices/German/VOICES2.PAK voices2+.pak
        ln -sf Data/Voices/German/VOICES3.PAK voices3+.pak
        ln -sf Data/Voices/German/VOICES4.PAK voices4+.pak
        ln -sf Data/Voices/German/VOICES5.PAK voices5+.pak
        ln -sf Data/Voices/German/VOICES6.PAK voices6+.pak
        ln -sf Data/Voices/German/VOICESGE.PAK voicesgen+.pak
        ;;
esac
echo "CURRENT_LANG=\"\$CURRENT_LANG\"" > pol_configuration

POL_SetupWindow_Close
exit

EOF

exit
